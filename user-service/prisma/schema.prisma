generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model addresses {
  address_id     String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id        String    @db.Uuid
  address_type   String    @db.VarChar(20)
  street_address String
  subcity        String    @db.VarChar(100)
  kebele         String    @db.VarChar(100)
  woreda         String?   @db.VarChar(100)
  house_number   String?   @db.VarChar(50)
  landmark       String?
  is_default     Boolean?  @default(false)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  updated_at     DateTime? @default(now()) @db.Timestamptz(6)
  users          users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_addresses_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model courier_availability {
  availability_id    String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  courier_profile_id String           @db.Uuid
  day_of_week        Int?
  start_time         DateTime         @db.Time(6)
  end_time           DateTime         @db.Time(6)
  is_recurring       Boolean?         @default(true)
  created_at         DateTime?        @default(now()) @db.Timestamptz(6)
  courier_profiles   courier_profiles @relation(fields: [courier_profile_id], references: [courier_profile_id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model courier_profiles {
  courier_profile_id         String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id                    String                 @unique @db.Uuid
  id_number                  String?                @db.VarChar(50)
  hire_date                  DateTime               @db.Date
  employment_type            String?                @db.VarChar(20)
  status                     String?                @default("AVAILABLE") @db.VarChar(15)
  rating                     Decimal?               @default(0) @db.Decimal(3, 2)
  total_deliveries_completed Int?                   @default(0)
  on_time_delivery_rate      Decimal?               @db.Decimal(5, 2)
  current_latitude           Decimal?               @db.Decimal(10, 8)
  current_longitude          Decimal?               @db.Decimal(11, 8)
  last_location_update       DateTime?              @db.Timestamptz(6)
  is_online                  Boolean?               @default(false)
  created_at                 DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at                 DateTime?              @default(now()) @db.Timestamptz(6)
  courier_availability       courier_availability[]
  users                      users                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  courier_ratings            courier_ratings[]
  vehicles                   vehicles[]

  @@index([current_latitude, current_longitude], map: "idx_courier_profiles_location")
  @@index([status, is_online], map: "idx_courier_profiles_status")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model courier_ratings {
  rating_id          String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  courier_profile_id String           @db.Uuid
  customer_id        String           @db.Uuid
  order_reference_id String           @db.Uuid
  rating             Int
  review_text        String?
  created_at         DateTime?        @default(now()) @db.Timestamptz(6)
  courier_profiles   courier_profiles @relation(fields: [courier_profile_id], references: [courier_profile_id], onDelete: Cascade, onUpdate: NoAction)
  users              users            @relation(fields: [customer_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([courier_profile_id], map: "idx_courier_ratings_courier")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model customer_profiles {
  customer_profile_id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id                       String    @unique @db.Uuid
  preferred_notification_method String?   @default("SMS") @db.VarChar(10)
  email_notifications_enabled   Boolean?  @default(true)
  sms_notifications_enabled     Boolean?  @default(true)
  created_at                    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                    DateTime? @default(now()) @db.Timestamptz(6)
  users                         users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
}

model user_sessions {
  session_id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id            String    @db.Uuid
  device_id          String?   @db.VarChar(255)
  device_type        String?   @db.VarChar(50)
  access_token_hash  String    @unique @db.VarChar(255)
  refresh_token_hash String    @unique @db.VarChar(255)
  expires_at         DateTime  @db.Timestamptz(6)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  last_activity_at   DateTime? @default(now()) @db.Timestamptz(6)
  users              users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, expires_at], map: "idx_user_sessions_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model users {
  user_id           String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email             String             @unique @db.VarChar(255)
  phone_number      String             @unique @db.VarChar(15)
  user_role         String             @default("CUSTOMER") @db.VarChar(20)
  password_hash     String             @db.VarChar(255)
  first_name        String             @db.VarChar(100)
  last_name         String             @db.VarChar(100)
  date_of_birth     DateTime?          @db.Date
  is_active         Boolean?           @default(true)
  is_verified       Boolean?           @default(false)
  created_at        DateTime?          @default(now()) @db.Timestamptz(6)
  updated_at        DateTime?          @default(now()) @db.Timestamptz(6)
  last_login_at     DateTime?          @db.Timestamptz(6)
  profile_image_url String?
  addresses         addresses[]
  courier_profiles  courier_profiles?
  courier_ratings   courier_ratings[]
  customer_profiles customer_profiles?
  user_sessions     user_sessions[]

  @@index([email], map: "idx_users_email")
  @@index([phone_number], map: "idx_users_phone")
  @@index([user_role, is_active], map: "idx_users_role")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model vehicles {
  vehicle_id         String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  courier_profile_id String           @db.Uuid
  vehicle_type       String           @db.VarChar(20)
  make               String?          @db.VarChar(100)
  model              String?          @db.VarChar(100)
  license_plate      String           @unique @db.VarChar(20)
  capacity_weight_kg Decimal?         @db.Decimal(6, 2)
  status             String?          @default("ACTIVE") @db.VarChar(20)
  is_available       Boolean?         @default(true)
  created_at         DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?        @default(now()) @db.Timestamptz(6)
  courier_profiles   courier_profiles @relation(fields: [courier_profile_id], references: [courier_profile_id], onDelete: Cascade, onUpdate: NoAction)


//////////////////////////////////////////////////
// IDEMPOTENCY
//////////////////////////////////////////////////

model ProcessedEvent {
  eventId    String   @id
  eventType  String
  service    String
  processedAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([eventId])
}
