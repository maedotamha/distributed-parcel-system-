generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS (from SQL CHECK constraints)
//
enum PaymentMethod {
  CASH_ON_DELIVERY
  MOBILE_MONEY
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  AUTHORIZED
  CAPTURED
  SETTLED
  REFUNDED
  PARTIALLY_REFUNDED
  FAILED
  CANCELLED
}

enum FeeType {
  BASE_FEE
  DISTANCE_FEE
  VEHICLE_MULTIPLIER
  PRIORITY_FEE
  SURGE_FEE
  WEIGHT_FEE
  VOLUME_FEE
  INSURANCE_FEE
  PAYMENT_PROCESSING_FEE
  TAX
  DISCOUNT
}

enum RefundStatus {
  PENDING
  PROCESSED
  FAILED
  CANCELLED
}

enum SettlementStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT
  REFUND
  ADJUSTMENT
}

//
// MODELS
//
model Payment {
  payment_id   String   @id @default(uuid()) @db.Uuid
  order_id     String   @db.Uuid
  customer_id  String   @db.Uuid
  payment_method PaymentMethod
  payment_gateway String?  @db.VarChar(50)
  gateway_transaction_id String? @db.VarChar(255)
  gateway_reference      String? @db.VarChar(255) @unique
  amount       Decimal  @db.Decimal(15,2)
  currency_code String  @db.Char(3) @default("ETB")
  status       PaymentStatus
  captured_amount Decimal @db.Decimal(15,2) @default(0)
  refunded_amount Decimal @db.Decimal(15,2) @default(0)
  description  String?  @db.Text
  metadata     Json?
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")
  authorized_at DateTime?
  captured_at   DateTime?
  settled_at    DateTime?

  fees        PaymentFee[]
  refunds     Refund[]
  walletTxns  WalletTransaction[]
  gatewayLogs GatewayLog[]

  @@index([order_id], name: "idx_payments_order")
  @@index([customer_id, status, created_at], name: "idx_payments_customer_status")
  @@index([status, created_at], name: "idx_payments_status_date")
}

model PaymentFee {
  fee_id     String   @id @default(uuid()) @db.Uuid
  payment_id String   @db.Uuid
  fee_type   FeeType
  description String? @db.VarChar(255)
  amount     Decimal  @db.Decimal(15,2)
  calculation_metadata Json?
  created_at DateTime @default(now()) @map("created_at")

  payment Payment @relation(fields: [payment_id], references: [payment_id], onDelete: Cascade)

  @@index([payment_id], name: "idx_payment_fees_payment")
}

model DeliveryFeeCalculation {
  calculation_id String   @id @default(uuid()) @db.Uuid
  order_id       String   @db.Uuid
  base_fee       Decimal  @db.Decimal(15,2)
  distance_km    Decimal? @db.Decimal(6,2)
  distance_fee   Decimal? @db.Decimal(15,2)
  vehicle_type   String?  @db.VarChar(20)
  vehicle_multiplier Decimal? @db.Decimal(5,2) @default(1.0)
  priority_level String?  @db.VarChar(20)
  priority_multiplier Decimal? @db.Decimal(5,2) @default(1.0)
  surge_multiplier Decimal? @db.Decimal(5,2) @default(1.0)
  weight_kg      Decimal? @db.Decimal(6,2)
  weight_surcharge Decimal? @db.Decimal(15,2)
  subtotal       Decimal  @db.Decimal(15,2)
  tax_rate       Decimal? @db.Decimal(5,2)
  tax_amount     Decimal? @db.Decimal(15,2)
  total_amount   Decimal  @db.Decimal(15,2)
  calculation_parameters Json
  is_applied     Boolean  @default(false)
  expires_at     DateTime?
  created_at     DateTime @default(now()) @map("created_at")

  @@index([order_id, expires_at], name: "idx_delivery_fee_calculations_order")
}

model Refund {
  refund_id     String   @id @default(uuid()) @db.Uuid
  payment_id    String   @db.Uuid
  refund_reason String   @db.VarChar(100)
  refund_amount Decimal  @db.Decimal(15,2)
  status        RefundStatus
  gateway_refund_id String? @db.VarChar(255)
  processed_by  String?  @db.Uuid
  notes         String?  @db.Text
  metadata      Json?
  created_at    DateTime @default(now()) @map("created_at")
  processed_at  DateTime?

  payment Payment @relation(fields: [payment_id], references: [payment_id], onDelete: Cascade)
}

model CourierSettlement {
  settlement_id String   @id @default(uuid()) @db.Uuid
  courier_id    String   @db.Uuid
  settlement_period_start DateTime @db.Date
  settlement_period_end   DateTime @db.Date
  total_orders  Int
  total_amount  Decimal  @db.Decimal(15,2)
  commission_amount Decimal? @db.Decimal(15,2)
  deductions    Decimal? @db.Decimal(15,2)
  net_amount    Decimal  @db.Decimal(15,2)
  currency_code String   @db.Char(3) @default("ETB")
  status        SettlementStatus @default(PENDING)
  payment_method String? @db.VarChar(30)
  transaction_reference String? @db.VarChar(255)
  paid_at       DateTime?
  created_at    DateTime @default(now()) @map("created_at")
  updated_at    DateTime @updatedAt @map("updated_at")

  details SettlementDetail[]

  @@index([courier_id, settlement_period_end], name: "idx_courier_settlements_courier")
}

model SettlementDetail {
  detail_id     String   @id @default(uuid()) @db.Uuid
  settlement_id String   @db.Uuid
  order_id      String   @db.Uuid
  order_amount  Decimal  @db.Decimal(15,2)
  commission_percentage Decimal? @db.Decimal(5,2)
  commission_amount Decimal? @db.Decimal(15,2)
  bonus_amount  Decimal? @db.Decimal(15,2)
  penalty_amount Decimal? @db.Decimal(15,2)
  net_amount    Decimal  @db.Decimal(15,2)
  created_at    DateTime @default(now()) @map("created_at")

  settlement CourierSettlement @relation(fields: [settlement_id], references: [settlement_id], onDelete: Cascade)
}

model CustomerWallet {
  wallet_id   String   @id @default(uuid()) @db.Uuid
  customer_id String   @db.Uuid @unique
  balance     Decimal  @db.Decimal(15,2) @default(0)
  currency_code String @db.Char(3) @default("ETB")
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  transactions WalletTransaction[]

  @@index([customer_id], name: "idx_customer_wallets_customer")
}

model WalletTransaction {
  transaction_id String   @id @default(uuid()) @db.Uuid
  wallet_id      String   @db.Uuid
  payment_id     String?  @db.Uuid
  transaction_type TransactionType
  amount         Decimal  @db.Decimal(15,2)
  running_balance Decimal @db.Decimal(15,2)
  description    String?  @db.Text
  reference_id   String?  @db.Uuid
  metadata       Json?
  created_at     DateTime @default(now()) @map("created_at")

  wallet  CustomerWallet @relation(fields: [wallet_id], references: [wallet_id], onDelete: Cascade)
  payment Payment?       @relation(fields: [payment_id], references: [payment_id])

  @@index([wallet_id, created_at], name: "idx_wallet_transactions_wallet")
}

model GatewayLog {
  log_id        String   @id @default(uuid()) @db.Uuid
  payment_id    String?  @db.Uuid
  gateway_name  String   @db.VarChar(50)
  request_type  String   @db.VarChar(50)
  request_body  String?  @db.Text
  response_body String?  @db.Text
  response_code Int?
  response_time_ms Int?
  is_successful Boolean?
  error_message String?
  created_at    DateTime @default(now()) @map("created_at")


//////////////////////////////////////////////////
// IDEMPOTENCY
//////////////////////////////////////////////////

model ProcessedEvent {
  eventId    String   @id
  eventType  String
  service    String
  processedAt DateTime @default(now()) @map("processed_at")

  @@index([eventId])
}
